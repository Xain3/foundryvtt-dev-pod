# FoundryVTT Dev Pod CLI

Minimal CLI for working with local multi-version Foundry containers during module development.

## Quickstart

- Generate compose from `container-config.json`:

```zsh
npx fvtt-compose-gen -c container-config.json -o compose.dev.yml
```

- Start services and tail logs:

```zsh
npx fvtt-pod up -d
npx fvtt-pod logs -f foundry-v13
```

## Configuration Validation

Both `fvtt-compose-gen` and `fvtt-pod` automatically validate your `container-config.json` file against structural requirements before processing. The validation ensures your configuration has all required properties and proper structure.

### What gets validated

- **Required top-level properties**: `systems`, `modules`, `versions`
- **Component validation**: Each system/module must have a `name` and either `manifest` or `path`
- **Version structure**: Version configs must include required `install` sections with `systems` and `modules` objects

### Validation in action

**Valid configuration passes silently**:

```zsh
npx fvtt-compose-gen -c container-config.json --dry-run
# [dry-run] Would generate compose YAML from config: /path/to/container-config.json
```

**Invalid configuration is caught early**:

```zsh
npx fvtt-compose-gen -c bad-config.json --dry-run
# Configuration validation failed:
#   /systems/my-system: must have either "manifest" or "path" property
#   /versions/13: must have required property "install"
```

### Standalone validation tool

You can also validate configurations directly:

```zsh
# Validate a config file
npx scripts/validate-config.js container-config.json

# Skip caching for fresh validation
npx scripts/validate-config.js container-config.json --no-cache
```

### Caching

The `fvtt-pod` command caches validation results to avoid repeated checks until your configuration changes. You'll see a "Validating container configuration..." message only when validation is actually performed.

## Secrets modes

Control how credentials are passed into containers during generation:

- `file` (default):
  - `--secrets-file ./secrets.json` and mounted in containers as `/run/secrets/config.json`.
- `external`:
  - `--secrets-external foundry_secrets` references an external secret managed by Docker/Swarm.
- `none`:
  - Omits secrets; use `env_file`/`environment` in compose instead.

Flags or env vars:

- Flags: `--secrets-mode`, `--secrets-file`, `--secrets-external`, `--secrets-target`
- Env: `COMPOSE_SECRETS_MODE`, `COMPOSE_SECRETS_FILE`, `COMPOSE_SECRETS_EXTERNAL_NAME`, `COMPOSE_SECRETS_TARGET`

## Pod helper

- Default compose file path: `compose.dev.yml` (from repo root)
- Custom compose file:

```zsh
npx fvtt-pod -f ./compose.dev.nonroot.yml up -d
```

## Safety

- This package is marked `private: true` in `package.json`. Remove that, set a unique name, add a license, then `npm publish --access public` if you choose to publish.
- Review `patches/README.md` for patch details.

## Acknowledgments

This tooling wraps and orchestrates development workflows around the excellent `felddy/foundryvtt-docker` image:

- [felddy/foundryvtt-docker](https://github.com/felddy/foundryvtt-docker)

Please refer to that project for base image details, environment variables, and licensing.

## CI & Coverage

- Pull requests into `master`/`main` run tests via GitHub Actions (Node 18).
- Coverage is generated by Jest. A per-folder gate enforces minimums using `.github/constants/thresholds.json`.
- Workflow file: `.github/workflows/pr-test-coverage.yml`.

Local run:

```zsh
npm install
npm run test:ci
npm run check-coverage
```

Configure thresholds:

- Edit `.github/constants/thresholds.json` to add/update rules.
- Each rule supports:
  - `name`: label for reporting
  - `match_mode`: `prefix` (default) or `regex`
  - `match`: path prefix or regex
  - `min`: required `{ branches, functions, lines, statements }`

Environment overrides:

- `THRESHOLDS_FILE`: alternate thresholds JSON path
- `COVERAGE_SUMMARY`: path to `coverage-summary.json` if non-standard
